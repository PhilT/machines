#!/usr/bin/env ruby

if ARGV.size > 2 && %w(install test).include?(ARGV[0])
  test = ARGV[0].downcase == 'test'
  puts "#{test ? 'Testing' : 'Beginning'} install..."
  require File.join(File.dirname(__FILE__), '..', 'lib', 'machines')
  configure ARGV[1], ARGV[2], ARGV[3], ARGV[4], ARGV[5] || ARGV[2]
  begin
    load File.join(Dir.pwd, 'Machinesfile')
  rescue LoadError
    puts "Machinesfile does not exist. Please create one."
    exit 1
  rescue NoMethodError
    puts "Have you selected the correct machine configuration?"
    raise
  end

  start ARGV[0]
  puts "#{test ? 'Test' : 'Install'} completed."
else
puts <<END
Machines allows simple configuration of development, staging and production computers or images for ec2
Usage: machines <command> <machine> <host> [username] [password] [dbmaster]

  command       one of 'test', 'install'
  machine       one of the configurations specified in Machinesfile
  host          the url of the remote machine
  username      the username for development installs
  machinename   name to give the computer for dev installs
  dbmaster      url to the master database server

  Commands:
    test      lists the commands that would be run but
              does not execute them on the remote machine

    install   installs the machine specified by config
END

end

