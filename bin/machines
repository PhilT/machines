#!/usr/bin/env ruby

if ARGV.size >= 4 && %w(install test).include?(ARGV[0])
  command = ARGV.shift
  test = command.downcase == 'test'
  puts "#{test ? 'Testing' : 'Beginning'} install..."
  require File.join(File.dirname(__FILE__), '..', 'lib', 'machines')
  configure ARGV
  begin
    load File.join(Dir.pwd, 'Machinesfile')
  rescue LoadError
    puts "Machinesfile does not exist. Please create one."
    exit 1
  rescue NoMethodError
    puts "Have you selected the correct machine configuration?"
    raise
  end

  start command
  puts "#{test ? 'Test' : 'Install'} completed."
else
puts <<END
Machines allows simple configuration of development, staging and production computers or images for ec2
Usage: machines <command> <machine> <host> <password> [dbmaster] [machinename] [username]

  command       one of 'test', 'install'
  machine       one of the configurations specified in Machinesfile
  host          the url of the remote machine
  password      the password. Must be encrypted. Use 'openssl passwd <password>'.
  dbmaster      url to the master database server. Defaults to host.
  machinename   name to give the computer. Defaults to <machine>.
  username      the username. Defaults to 'www'.

  Commands:
    test      lists the commands that would be run but
              does not execute them on the remote machine

    install   installs the machine specified by config
END

end

